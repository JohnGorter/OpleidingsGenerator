<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-elements/paper-elements.html">
<link rel="import" href="../bower_components/iron-elements/iron-elements.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../elements/training-education-plan/training-education-plan.html">
<link rel="import" href="../elements/training-education-plan-ajax/training-education-plan-ajax.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<dom-module id="educationplan-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
      
      .card {
        display: flex;
      }
      
      .card > div {
        margin: 10px;
      }
      
      .card > div:nth-child(1) {
        flex: 3;
      }
      
      .card > div:nth-child(2) {
        flex: 1;
      }

      paper-toast {
        cursor: pointer;
      }

      #btnContainer paper-button{
        width: 100%;
        margin-top: 10px;
      }


        paper-button.green {
            background-color: var(--paper-green-500);
            color: white;
        }

        paper-button.yellow {
            background-color: var(--paper-yellow-800);
            color: white;
        }


        paper-button.red {
            background-color: var(--paper-red-500);
            color: white;
        }
    </style>

<app-route route="{{route}}" pattern="/:id" tail="{{subroute}}"></app-route>
<app-route route="{{subroute}}" pattern="/:id" data="{{routeData}}"></app-route>
<training-education-plan-ajax id="ajaxGETEducationPlan" auto education-plan-id="[[routeData.id]]" education-plan="{{educationPlan}}"></training-education-plan-ajax>

      <iron-ajax id="ajaxDownloadEducationPlan" method="GET" handle-as="json" debounce-duration="500" content-type="application/json"
                 on-response="_handleResponseDownload"></iron-ajax>

      <iron-ajax id="ajaxApproveEducationPlan" method="POST" handle-as="json" debounce-duration="500" content-type="application/json"
                 on-response="_handleResponseApprove"></iron-ajax>

<div class="card">
  <div>
    <training-education-plan education-plan="{{educationPlan}}"></training-education-plan>
  </div>
  <div id="btnContainer">
    <paper-button class="green" on-tap="_downloadEducationPlan" raised>Opleidingsplan downloaden</paper-button>
    <paper-button class="yellow" on-tap="_changeEducationPlan" raised>Opleidingsplan aanpassen</paper-button>

    <div id="status"><h1>Status: [[_getStatus(educationPlan.Status)]]</h1></div>

    <template is="dom-if" if="[[_isEducationplanStatus(educationPlan.Status, 1)]]">
          <paper-button class="yellow" on-tap="_completeEducationPlan" raised id="btnApproved">Opleidingsplan als voltooid markeren</paper-button>
    </template>
    <template is="dom-if" if="[[_isEducationplanStatus(educationPlan.Status, 0)]]">
        <paper-button class="yellow" on-tap="_approveEducationPlan" raised id="btnApproved">Opleidingsplan goedkeuren</paper-button>
    </template>
</div>
</div>

</template>

<script>
  Polymer({
    is: 'educationplan-view',
    properties: {
      profile: String,
    },
    loadEducationPlanView: function () {
        var routesArray = this.route.path.split("/");
        var id = routesArray[routesArray.length - 1];
        if (!isNaN(id)) {
        this.$.ajaxGETEducationPlan.generateRequest();
      }
    },
    _formatDate: function (dateAsString) {
      if (dateAsString == null) {
        return "-";
      }
      var date = new Date(dateAsString);
      return date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear();
    },
    _isEducationplanStatus: function (status, statusToCheck) {
        return statusToCheck === status;
    },
    _getStatus: function (status) {
        var statusString = "";
        switch (status) {
            case 0:
                statusString = "Initieel";
                break;
            case 1:
                statusString = "Goedgekeurd";
                break;
            case 2:
                statusString = "Voltooid";
                break;
            default:
        }

        return statusString;
    },
    handleResponse: function (educationPlan) {
      this.educationPlan = educationPlan.detail.response;
    },
    _changeEducationPlan: function (event) {
      this.set('route.path', '/educationplan-generator-view/' + this.routeData.id);
    },
    _downloadEducationPlan: function () {
        var downloadPath = BackendAdress + "/api/GenerateWordFile/" + this.routeData.id;
      this.$.ajaxDownloadEducationPlan.url = downloadPath;
      this.$.ajaxDownloadEducationPlan.generateRequest();
    },
    _handleResponseDownload: function (response) {
        window.open(BackendAdress + "/Data/EducationPlanFiles/" + response.detail.response, '_blank', '');
    },
    _approveEducationPlan: function() {
        var approveURL = BackendAdress + "/api/ApproveEducationPlan/" + this.routeData.id;
        this.$.ajaxApproveEducationPlan.url = approveURL;
        this.$.ajaxApproveEducationPlan.generateRequest();
    },
    _completeEducationPlan: function () {
        var approveURL = BackendAdress + "/api/CompletedEducationPlan/" + this.routeData.id;
        this.$.ajaxApproveEducationPlan.url = approveURL;
        this.$.ajaxApproveEducationPlan.generateRequest();
    },
    _handleResponseApprove: function () {
        this.set('route.path', '/educationplan-approved-overview-view');
    }
  });
</script>
</dom-module>